<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Consulta por NP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* T√≠tulo */
    h1 {
      font-size: 1.3rem;
      margin: 0 0 12px;
      text-align: center;
    }

    .np-highlight {
      font-weight: bold;
      font-size: 1.1rem;
      margin: 8px 0 16px;
      text-align: center;
    }

    .status {
      margin: 8px 0 16px;
      font-size: 0.95rem;
      padding: 8px 12px;
      border-radius: 8px;
      background: #eee;
    }
    .status.error {
      background: #ffe5e5;
      color: #a40000;
    }
    .status.success {
      background: #e5ffe9;
      color: #006614;
    }

    .field-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .field-table th,
    .field-table td {
      padding: 6px 8px;
      vertical-align: top;
      border-bottom: 1px solid #f0f0f0;
    }
    .field-table th {
      text-align: left;
      width: 40%;
      color: #374151;
      font-weight: 600;
    }
    .field-table td {
      color: #111827;
      word-break: break-word;
    }

    .search-box {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .search-box input[type="text"] {
      flex: 1;
      padding: 8px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }
    .search-box button {
      padding: 8px 12px;
      font-size: 0.95rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: white;
      white-space: nowrap;
    }
    .camera-button {
      background: #10b981;
    }

    .csv-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 0.85rem;
      margin-bottom: 12px;
    }
    .csv-controls button {
      padding: 6px 10px;
      border-radius: 8px;
      border: none;
      font-size: 0.85rem;
      cursor: pointer;
      background: #28a745;
      color: white;
      white-space: nowrap;
    }
    .csv-controls button.secondary {
      background: #6c757d;
    }
    .csv-controls input[type="file"] {
      font-size: 0.8rem;
    }

    /* Foto de Finaliza√ß√£o */
    .foto-label {
      font-weight: 600;
      margin-right: 6px;
    }
    .foto-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .foto-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.85rem;
    }
    .foto-link {
      color: #2563eb;
      text-decoration: underline;
      cursor: pointer;
    }
    .btn-baixar-foto {
      padding: 4px 8px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      background: #10b981;
      color: #fff;
    }
    .foto-finalizacao {
      margin-top: 8px;
      max-width: 100%;
      width: 100%;
      border-radius: 8px;
      display: block;
    }

    .small {
      font-size: 0.75rem;
      color: #4b5563;
      margin-top: 12px;
      text-align: justify;
    }

    /* √Årea da c√¢mera para QR */
    #cameraContainer {
      display: none;
      margin-bottom: 12px;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
      position: relative;
    }
    #qrVideo {
      width: 100%;
      display: block;
    }
    .qr-hint {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 4px;
      text-align: center;
      color: #fff;
      font-size: 0.75rem;
      text-shadow: 0 1px 3px rgba(0,0,0,0.6);
      padding: 2px 4px;
    }
    .qr-close {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border-radius: 999px;
      border: none;
      padding: 4px 8px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    /* Logos no rodap√© */
    .footer-logos {
      margin-top: 20px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .footer-logo-img {
      height: 40px;
      object-fit: contain;
    }

    @media (max-width: 480px) {
      body {
        padding: 8px;
      }
      .container {
        padding: 12px;
      }
      .search-box {
        flex-direction: column;
      }
      .search-box button {
        width: 100%;
        justify-content: center;
      }
      .csv-controls {
        flex-direction: column;
        align-items: stretch;
      }
      .csv-controls button {
        width: 100%;
      }
    }
  </style>

  <!-- Papaparse local -->
  <script src="./papaparse.min.js"></script>
  <!-- Biblioteca de leitura de QR -->
  <script src="./jsQR.js"></script>
</head>
<body>
  <div class="container">
    <h1>Consulta r√°pida de NP</h1>

    <!-- Busca manual + bot√£o de c√¢mera -->
    <div class="search-box">
      <input id="manualNp" type="text" placeholder="Digite o NP (ex: ab-011)" />
      <button onclick="buscarManual()">Buscar</button>
      <button onclick="iniciarCamera()" class="camera-button">üì∑ Ler QR</button>
    </div>

    <!-- Controles de CSV -->
    <div class="csv-controls">
      <button type="button" onclick="carregarCsvPadrao()">Usar CSV padr√£o (dados.csv)</button>
      <button type="button" class="secondary" onclick="document.getElementById('csvInput').click()">
        Carregar CSV do aparelho
      </button>
      <input id="csvInput" type="file" accept=".csv" style="display:none;" />
    </div>

    <!-- √Årea de c√¢mera -->
    <div id="cameraContainer">
      <button class="qr-close" onclick="pararCamera()">Fechar</button>
      <video id="qrVideo" playsinline></video>
      <div class="qr-hint">
        Aponte a c√¢mera para o QR Code. A leitura para automaticamente ao encontrar um c√≥digo.
      </div>
    </div>

    <div id="npInfo" class="np-highlight"></div>
    <div id="status" class="status">Carregando dados...</div>
    <table id="resultTable" class="field-table" style="display:none;"></table>

    <div class="small">
      <strong>Programa de Gest√£o do Patrim√¥nio Arqueol√≥gico - Estrutura de Disposi√ß√£o de Rejeitos/Res√≠duos 9 (EDR 9)</strong><br>
      <strong>Portaria 01514.002457/2018-69</strong>
    </div>

    <div class="footer-logos">
      <img src="./imgs/logo_edr9_cbmm.jpg" class="footer-logo-img" alt="EDR9 CBMM" />
      <img src="./imgs/logo_vaz_intangivel.jpg" class="footer-logo-img" alt="Vaz Intang√≠vel" />
    </div>
  </div>

  <script>
    const CSV_FILE = 'dados.csv';

    let registros = [];
    let streamCamera = null;
    let qrAtivo = false;

    function getNpFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const np = params.get('np');
      return np ? np.trim() : null;
    }

    function setStatus(message, isError = false) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.classList.toggle('error', isError);
      statusEl.classList.toggle('success', !isError && message);
    }

    function limparTabela() {
      document.getElementById('resultTable').style.display = 'none';
      document.getElementById('resultTable').innerHTML = '';
      document.getElementById('npInfo').textContent = '';
    }

    function normalizarNp(np) {
      if (!np) return '';
      return np.toString().trim().toLowerCase();
    }

    function normalizarUrlFoto(url) {
      if (!url) return '';
      let limpa = url.split(/\s+/)[0];
      limpa = limpa.replace('https://storage.cloud.google.com/', 'https://storage.googleapis.com/');
      return limpa;
    }

    function carregarCsvPadrao() {
      setStatus('Carregando CSV padr√£o...', false);
      limparTabela();

      fetch(CSV_FILE)
        .then(response => {
          if (!response.ok) {
            throw new Error('N√£o foi poss√≠vel carregar o CSV padr√£o.');
          }
          return response.text();
        })
        .then(csvText => {
          Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            delimiter: ';',
            complete: function(results) {
              registros = results.data || [];
              if (registros.length === 0) {
                setStatus('CSV padr√£o carregado, mas est√° vazio.', true);
                return;
              }
              setStatus('CSV padr√£o carregado com sucesso.', false);

              const npUrl = getNpFromUrl();
              if (npUrl) {
                document.getElementById('manualNp').value = npUrl;
                buscarPorNp(npUrl);
              }
            },
            error: function(err) {
              console.error(err);
              setStatus('Erro ao analisar o CSV padr√£o.', true);
            }
          });
        })
        .catch(err => {
          console.error(err);
          setStatus('Erro ao carregar CSV padr√£o. Verifique se o arquivo dados.csv est√° dispon√≠vel.', true);
        });
    }

    document.getElementById('csvInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      setStatus('Carregando CSV do aparelho...', false);
      limparTabela();

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        delimiter: ';',
        complete: function(results) {
          registros = results.data || [];
          if (registros.length === 0) {
            setStatus('CSV carregado, mas n√£o h√° registros.', true);
            return;
          }
          setStatus('CSV carregado com sucesso a partir do aparelho.', false);
        },
        error: function(err) {
          console.error(err);
          setStatus('Erro ao analisar o CSV do aparelho.', true);
        }
      });
    });

    function buscarManual() {
      const np = document.getElementById('manualNp').value;
      if (!np) {
        setStatus('Digite um NP para buscar.', true);
        return;
      }
      buscarPorNp(np);
    }

    function buscarPorNp(np) {
      if (!registros || registros.length === 0) {
        setStatus('Nenhum CSV carregado. Carregue um CSV ou use o padr√£o antes de buscar.', true);
        return;
      }

      const npNormalizado = normalizarNp(np);
      const registro = registros.find(r => {
        const v = (r['np'] || r['NP'] || '').toString().trim().toLowerCase();
        return v === npNormalizado;
      });

      if (!registro) {
        limparTabela();
        setStatus(`NP "${np}" n√£o encontrado no CSV.`, true);
        return;
      }

      setStatus('Registro encontrado.', false);
      mostrarRegistro(registro, np);
    }

    function mostrarRegistro(registro, npBuscado) {
      const tabela = document.getElementById('resultTable');
      tabela.innerHTML = '';
      tabela.style.display = 'table';

      const npInfo = document.getElementById('npInfo');
      npInfo.textContent = `NP: ${npBuscado}`;

      const htmlParts = [];

      function addRow(label, valor) {
        if (valor === undefined || valor === null || valor === '') return;
        const texto = String(valor);
        htmlParts.push(`
          <tr>
            <th>${label}</th>
            <td>${texto}</td>
          </tr>
        `);
      }

      const sitio = registro['sitio'] || registro['S√≠tio'] || registro['sitio_nome'];
      if (sitio) {
        addRow('S√≠tio', sitio);
      }

      const valorNp = registro['np'] || registro['NP'];
      addRow('NP', valorNp);

      const qtde = registro['qtde'] || registro['QTDE'] || registro['quantidade'];
      addRow('Quantidade', qtde);

      const urlOriginal = registro['fotoFinalizacao'] || registro['foto_finalizacao'] || registro['FotoFinalizacao'];
      const urlFoto = normalizarUrlFoto(urlOriginal);

      if (urlFoto) {
        const urlFotoParaOnclick = urlFoto.replace(/"/g, '&quot;');
        htmlParts.push(`
          <tr>
            <th colspan="2">
              <div class="foto-header">
                <span class="foto-label">Foto de Finaliza√ß√£o:</span>
                <div class="foto-actions">
                  <span class="foto-link" onclick="window.open('${urlFotoParaOnclick}', '_blank')">
                    Abrir em nova aba
                  </span>
                  <button type="button" class="btn-baixar-foto" onclick="baixarFoto('${urlFotoParaOnclick}')">
                    Baixar imagem
                  </button>
                </div>
              </div>
            </th>
          </tr>
          <tr>
            <td colspan="2">
              <img src="${urlFotoParaOnclick}" alt="Foto de Finaliza√ß√£o" class="foto-finalizacao"
                   onerror="this.style.display='none';" />
            </td>
          </tr>
        `);
      }

      const dataFoto = registro['dateFoto'] || registro['data_foto'] || registro['DataFoto'];
      addRow('Data da Foto', dataFoto);

      addRow('L√≥cus', registro['locus']);
      addRow('UE', registro['UE']);

      addRow('Quadr√≠cula - Letra', registro['quadriculaLetra']);
      addRow('Quadr√≠cula - N√∫mero', registro['quadriculaNumero']);

      addRow('N√≠vel', registro['nivel']);

      addRow('Latitude (graus)', registro['latitude_degrees']);
      addRow('Longitude (graus)', registro['longitude_degrees']);
      addRow('Altitude (m)', registro['_altitude']);

      addRow('Tipo de Atividade', registro['branchTipoAtividade']);
      addRow('Origem do Material', registro['branchOrigemMaterial']);

      tabela.innerHTML = htmlParts.join('');
    }

    async function baixarFoto(url) {
      try {
        if (!url) {
          alert('Nenhuma URL de foto dispon√≠vel para download.');
          return;
        }

        const resposta = await fetch(url);
        if (!resposta.ok) {
          throw new Error('Resposta de rede n√£o OK');
        }
        const blob = await resposta.blob();
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const nomeArquivo = (url.split('/').pop() || 'foto-finalizacao').split('?')[0];

        a.href = blobUrl;
        a.download = nomeArquivo || 'foto-finalizacao';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(blobUrl);
      } catch (erro) {
        console.error('Erro ao baixar a foto:', erro);
        alert('N√£o foi poss√≠vel baixar a imagem. Verifique a conex√£o ou se o arquivo √© p√∫blico.');
      }
    }

    async function iniciarCamera() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('A c√¢mera n√£o √© suportada neste dispositivo ou navegador.');
        return;
      }

      const cameraContainer = document.getElementById('cameraContainer');
      const video = document.getElementById('qrVideo');

      cameraContainer.style.display = 'block';

      try {
        streamCamera = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }
        });
        video.srcObject = streamCamera;
        video.setAttribute('playsinline', true);
        video.play();

        qrAtivo = true;
        lerLoopQrCode(video);
      } catch (err) {
        console.error(err);
        alert('N√£o foi poss√≠vel acessar a c√¢mera.');
        cameraContainer.style.display = 'none';
      }
    }

    function pararCamera() {
      qrAtivo = false;
      if (streamCamera) {
        const tracks = streamCamera.getTracks();
        tracks.forEach(track => track.stop());
        streamCamera = null;
      }
      document.getElementById('cameraContainer').style.display = 'none';
    }

    function lerLoopQrCode(video) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      const loop = () => {
        if (!qrAtivo) return;

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);

          if (code && code.data) {
            qrAtivo = false;
            pararCamera();

            const conteudo = code.data.trim();
            let npLido = conteudo;

            try {
              const url = new URL(conteudo);
              const paramNp = url.searchParams.get('np');
              if (paramNp) {
                npLido = paramNp;
              }
            } catch (e) {}

            document.getElementById('manualNp').value = npLido;
            buscarPorNp(npLido);
            return;
          }
        }
        requestAnimationFrame(loop);
      };
      requestAnimationFrame(loop);
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .catch(err => console.warn('Service Worker n√£o registrado:', err));
      });
    }

    carregarCsvPadrao();
  </script>
</body>
</html>
