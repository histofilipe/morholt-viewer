<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Consulta por NP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: #ffffff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    h1 {
      font-size: 1.3rem;
      margin-top: 0;
      text-align: center;
    }

    /* Header com logos esquerda/direita e t칤tulo abaixo */
    .app-header {
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f0f0f0;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      width: 100%;
      margin-bottom: 6px;
    }

    .header-logo {
      height: 36px;
      max-width: 200px;
      object-fit: contain;
      display: block;
    }

    @media (min-width: 768px) {
      .header-logo {
        height: 48px;
      }
    }

    @media (max-width: 480px) {
      .header-top {
        justify-content: center;
      }
      .header-logo {
        height: 30px;
        max-width: 160px;
      }
    }

    .app-title-block {
      text-align: center;
    }

    .app-title-block h1 {
      font-size: 1.15rem;
      margin: 0;
      text-align: center;
    }

    .app-subtitle {
      font-size: 0.8rem;
      color: #6b7280;
      margin: 2px 0 0;
      text-align: center;
    }

    .np-highlight {
      font-weight: bold;
      font-size: 1.1rem;
      margin: 8px 0 16px;
      text-align: center;
    }
    .status {
      margin: 8px 0 16px;
      font-size: 0.95rem;
      padding: 8px 12px;
      border-radius: 8px;
      background: #eee;
    }
    .status.error {
      background: #ffe5e5;
      color: #a40000;
    }
    .status.success {
      background: #e5ffe9;
      color: #006614;
    }
    .field-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .field-table th,
    .field-table td {
      padding: 6px 8px;
      vertical-align: top;
      border-bottom: 1px solid #f0f0f0;
    }
    .field-table th {
      text-align: left;
      width: 40%;
      font-weight: 600;
      background: #fafafa;
    }
    .field-table tr:nth-child(even) td {
      background: #fcfcfc;
    }
    .small {
      font-size: 0.8rem;
      color: #777;
      margin-top: 16px;
      text-align: center;
    }
    .search-box {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .search-box input {
      flex: 1;
      min-width: 140px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
    }
    .search-box button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      font-size: 0.95rem;
      cursor: pointer;
      background: #007bff;
      color: white;
      white-space: nowrap;
    }
    .search-box button:active {
      opacity: 0.8;
    }

    /* 츼rea de c칙mera / QR */
    .qr-area {
      margin-top: 12px;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .qr-area video {
      width: 100%;
      max-width: 400px;
      border-radius: 12px;
      background: #000;
    }
    .qr-hint {
      font-size: 0.8rem;
      color: #555;
      text-align: center;
    }

    /* Controles de CSV */
    .csv-controls {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 0.85rem;
    }
    .csv-controls button {
      padding: 6px 10px;
      border-radius: 8px;
      border: none;
      font-size: 0.85rem;
      cursor: pointer;
      background: #28a745;
      color: white;
      white-space: nowrap;
    }
    .csv-controls button.secondary {
      background: #6c757d;
    }
    .csv-controls input[type="file"] {
      font-size: 0.8rem;
    }

    /* Foto de Finaliza칞칚o */
    .foto-label {
      font-weight: 600;
      margin-right: 6px;
    }
    .foto-header {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }
    .foto-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .foto-actions a {
      font-size: 0.85rem;
    }
    .btn-baixar-foto {
      padding: 4px 8px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      background: #007bff;
      color: #fff;
    }
    .foto-finalizacao {
      margin-top: 8px;
      max-width: 100%;
      width: 100%;
      border-radius: 8px;
      display: block;
    }
  </style>

  <!-- Papaparse local -->
  <script src="./papaparse.min.js"></script>
  <!-- Biblioteca de leitura de QR -->
  <script src="./jsQR.js"></script>
</head>
<body>
  <div class="container">
    <header class="app-header">
      <div class="header-top">
        <!-- Logo esquerdo -->
        <img src="./imgs/logo_edr9_cbmm.jpg"
             alt="Projeto EDR9 | CBMM"
             class="header-logo" />

        <!-- Logo direito -->
        <img src="./imgs/logo_vaz_intangivel.jpg"
             alt="Intang칤vel | Vaz"
             class="header-logo" />
      </div>

      <div class="app-title-block">
        <h1>Morholt Viewer</h1>
        <p class="app-subtitle">Consulta r치pida de NP</p>
      </div>
    </header>

    <!-- Busca manual + bot칚o de c칙mera -->
    <div class="search-box">
      <input id="manualNp" type="text" placeholder="Digite o NP (ex: ab-011)" />
      <button onclick="buscarManual()">Buscar</button>
      <button onclick="iniciarLeituraQr()">游닝 Ler QR</button>
    </div>

    <!-- Controles de CSV (padr칚o + arquivo local) -->
    <div class="csv-controls">
      <button onclick="carregarCsvPadrao()">Usar CSV padr칚o (dados.csv)</button>
      <button class="secondary" onclick="document.getElementById('csvFileInput').click()">
        Carregar CSV do aparelho
      </button>
      <input id="csvFileInput" type="file" accept=".csv" style="display:none;" />
      <span id="csvInfo"></span>
    </div>

    <!-- 츼rea da c칙mera -->
    <div id="qrArea" class="qr-area">
      <video id="qrVideo" playsinline></video>
      <div class="qr-hint">
        Aponte a c칙mera para o QR Code. A leitura para automaticamente ao encontrar um c칩digo.
      </div>
    </div>

    <div id="npInfo" class="np-highlight"></div>
    <div id="status" class="status">Carregando dados...</div>
    <table id="resultTable" class="field-table" style="display:none;"></table>

    <div class="small">
      <strong>Programa de Gest칚o do Patrim칪nio Arqueol칩gico - Estrutura de Disposi칞칚o de Rejeitos/Res칤duos 9 (EDR 9)</strong> .<br> 
      <strong>Portaria 01514.002457/2018-69</strong>.
    </div>
  </div>

  <script>
    // 游녤 CSV padr칚o
    const CSV_FILE = 'dados.csv';

    let registros = [];
    let cabecalho = [];
    let fonteAtual = 'padr칚o'; // 'padr칚o' ou 'local'

    // deixamos essa constante aqui se quiser reaproveitar no futuro
    const CAMPOS_VISIVEIS = [
      'np',
      'material',
      'qtde',
      'sitio',
      'added_sitio',
      'locus',
      'UE',
      'nivel',
      'quadriculaLetra',
      'quadriculaNumero',
      'latitude_degrees',
      'longitude_degrees',
      '_altitude',
      'branchTipoAtividade',
      'branchOrigemMaterial',
      'dateFoto',
      'hipoteseSerTestada',
      'obs_inicial',
      'obs_final'
    ];

    const LABELS = {
      np: 'NP',
      material: 'Material',
      qtde: 'Quantidade',
      sitio: 'S칤tio',
      added_sitio: 'S칤tio (derivado)',
      locus: 'L칩cus',
      UE: 'UE',
      nivel: 'N칤vel',
      quadriculaLetra: 'Quadr칤cula - Letra',
      quadriculaNumero: 'Quadr칤cula - N칰mero',
      latitude_degrees: 'Latitude (graus)',
      longitude_degrees: 'Longitude (graus)',
      _altitude: 'Altitude (m)',
      branchTipoAtividade: 'Tipo de Atividade',
      branchOrigemMaterial: 'Origem do Material',
      dateFoto: 'Data da Foto',
      hipoteseSerTestada: 'Hip칩tese a ser testada',
      obs_inicial: 'Observa칞칚o inicial',
      obs_final: 'Observa칞칚o final'
    };

    function getNpFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const np = params.get('np');
      return np ? np.trim() : null;
    }

    function setStatus(msg, tipo = '') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = msg;
      statusEl.className = 'status';
      if (tipo) statusEl.classList.add(tipo);
    }

    function setCsvInfo(texto) {
      document.getElementById('csvInfo').textContent = texto || '';
    }

    function addRow(htmlArray, label, value) {
      if (value === undefined || value === null) return;
      const texto = value.toString().trim();
      if (!texto) return;
      htmlArray.push(`
        <tr>
          <th>${label}</th>
          <td>${texto}</td>
        </tr>
      `);
    }

    function mostrarRegistro(registro, npBuscado) {
      const npInfo = document.getElementById('npInfo');
      const tabela = document.getElementById('resultTable');

      npInfo.textContent = npBuscado ? `NP consultado: ${npBuscado}` : '';

      if (!registro) {
        tabela.style.display = 'none';
        setStatus('Nenhum registro encontrado para este NP.', 'error');
        return;
      }

      const htmlParts = [];

      // 1) S칤tio (sitio ou added_sitio)
      const valorSitio = (registro['sitio'] || registro['added_sitio'] || '').toString().trim();
      addRow(htmlParts, 'S칤tio', valorSitio);

      // 2) NP
      const valorNp = (registro['np'] || registro['NP'] || '').toString().trim();
      addRow(htmlParts, 'NP', valorNp);

      // 3) Quantidade (NOVO, logo ap칩s NP)
      addRow(htmlParts, 'Quantidade', registro['qtde']);

      // 4) Foto de Finaliza칞칚o (linha especial com colspan e imagem grande)
      const urlFotoBruta = (registro['fotoFinalizacao'] || '').toString().trim();
      const urlFoto = normalizarUrlFoto(urlFotoBruta);
      const urlFotoParaOnclick = urlFotoBruta.replace(/'/g, "\\'");
      if (urlFoto) {
        htmlParts.push(`
          <tr>
            <td colspan="2">
              <div class="foto-header">
                <span class="foto-label">Foto de Finaliza칞칚o:</span>
                <div class="foto-actions">
                  <a href="${urlFoto}" target="_blank" rel="noopener noreferrer">
                    Abrir em nova aba
                  </a>
                  <button type="button" class="btn-baixar-foto" onclick="baixarFoto('${urlFotoParaOnclick}')">
                    Baixar imagem
                  </button>
                </div>
              </div>
              <img src="${urlFoto}" alt="Foto de finaliza칞칚o" class="foto-finalizacao"
                   onerror="this.style.display='none';" />
            </td>
          </tr>
        `);
      }

      // 5) Data da Foto
      addRow(htmlParts, 'Data da Foto', registro['dateFoto']);

      // 6) L칩cus
      addRow(htmlParts, 'L칩cus', registro['locus']);

      // 7) UE
      addRow(htmlParts, 'UE', registro['UE']);

      // 8) Quadr칤cula - Letra
      addRow(htmlParts, 'Quadr칤cula - Letra', registro['quadriculaLetra']);

      // 9) Quadr칤cula - N칰mero
      addRow(htmlParts, 'Quadr칤cula - N칰mero', registro['quadriculaNumero']);

      // 10) N칤vel
      addRow(htmlParts, 'N칤vel', registro['nivel']);

      // 11) Latitude, Longitude, Altitude
      addRow(htmlParts, 'Latitude (graus)', registro['latitude_degrees']);
      addRow(htmlParts, 'Longitude (graus)', registro['longitude_degrees']);
      addRow(htmlParts, 'Altitude (m)', registro['_altitude']);

      // 12) Tipo de Atividade e Origem do Material
      addRow(htmlParts, 'Tipo de Atividade', registro['branchTipoAtividade']);
      addRow(htmlParts, 'Origem do Material', registro['branchOrigemMaterial']);

      if (htmlParts.length === 0) {
        tabela.style.display = 'none';
        setStatus('Registro encontrado, mas sem campos vis칤veis configurados.', 'error');
        return;
      }

      tabela.innerHTML = htmlParts.join('');
      tabela.style.display = 'table';
      setStatus('Registro encontrado com sucesso.', 'success');
    }

    function buscarPorNp(npValor) {
      if (!npValor) {
        setStatus('Informe um NP para buscar.', 'error');
        mostrarRegistro(null, null);
        return;
      }

      const npNormalizado = npValor.toString().trim().toLowerCase();

      const registro = registros.find(r => {
        const v = (r['np'] || r['NP'] || '').toString().trim().toLowerCase();
        return v === npNormalizado;
      });

      mostrarRegistro(registro, npValor);
    }

    function buscarManual() {
      const valor = document.getElementById('manualNp').value;
      buscarPorNp(valor);

      const url = new URL(window.location);
      if (valor) {
        url.searchParams.set('np', valor);
      } else {
        url.searchParams.delete('np');
      }
      window.history.replaceState({}, '', url);
    }

    // ========= CARREGAMENTO DE CSV =========

    function carregarCsvPadrao() {
      fonteAtual = 'padr칚o';
      setStatus('Carregando CSV padr칚o (dados.csv)...');
      setCsvInfo('Usando CSV padr칚o (dados.csv)');
      Papa.parse(CSV_FILE, {
        download: true,
        header: true,
        skipEmptyLines: true,
        delimiter: ';',
        complete: onCsvCarregado,
        error: function(err) {
          console.error(err);
          setStatus('Erro ao carregar o CSV padr칚o.', 'error');
        }
      });
    }

    function carregarCsvLocal(arquivo) {
      if (!arquivo) return;
      fonteAtual = 'local';
      setStatus(`Carregando CSV local: ${arquivo.name}...`);
      setCsvInfo(`Usando CSV local: ${arquivo.name}`);
      Papa.parse(arquivo, {
        header: true,
        skipEmptyLines: true,
        delimiter: ';',
        complete: onCsvCarregado,
        error: function(err) {
          console.error(err);
          setStatus('Erro ao carregar o CSV local.', 'error');
        }
      });
    }

    function onCsvCarregado(results) {
      if (results.errors && results.errors.length > 0) {
        console.warn('Erros ao ler CSV:', results.errors);
      }

      registros = results.data || [];
      cabecalho = results.meta && results.meta.fields ? results.meta.fields : [];

      if (registros.length === 0) {
        setStatus('Nenhum dado encontrado no CSV.', 'error');
        return;
      }

      const npUrl = getNpFromUrl();
      if (npUrl) {
        document.getElementById('manualNp').value = npUrl;
        buscarPorNp(npUrl);
      } else {
        setStatus('Digite um NP, use um QR ou selecione um CSV.', '');
      }
    }

    document.getElementById('csvFileInput').addEventListener('change', (event) => {
      const arquivo = event.target.files[0];
      if (arquivo) {
        carregarCsvLocal(arquivo);
      }
    });

    // ========= LEITURA DE QR COM C츽MERA =========
    let qrStream = null;
    let qrAnimationId = null;

    async function iniciarLeituraQr() {
      const qrArea = document.getElementById('qrArea');
      const video = document.getElementById('qrVideo');

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        setStatus('Este dispositivo/navegador n칚o suporta acesso  c칙mera.', 'error');
        return;
      }

      try {
        setStatus('Abrindo c칙mera para leitura de QR...', '');
        qrArea.style.display = 'flex';

        qrStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false
        });

        video.srcObject = qrStream;
        await video.play();

        iniciarLoopQr(video);
      } catch (err) {
        console.error(err);
        setStatus('N칚o foi poss칤vel acessar a c칙mera (permiss칚o negada ou erro).', 'error');
      }
    }

    function pararLeituraQr() {
      if (qrAnimationId) {
        cancelAnimationFrame(qrAnimationId);
        qrAnimationId = null;
      }
      if (qrStream) {
        qrStream.getTracks().forEach(t => t.stop());
        qrStream = null;
      }
      const qrArea = document.getElementById('qrArea');
      const video = document.getElementById('qrVideo');
      video.srcObject = null;
      qrArea.style.display = 'none';
    }

    function tratarResultadoQr(texto) {
      setStatus('QR lido: ' + texto, 'success');

      let np = null;

      try {
        const url = new URL(texto);
        const param = url.searchParams.get('np');
        if (param) np = param;
      } catch (e) {
        // n칚o era URL
      }

      if (!np) np = texto;

      if (np) {
        document.getElementById('manualNp').value = np;
        buscarPorNp(np);
      } else {
        setStatus('QR lido, mas n칚o foi poss칤vel identificar o NP.', 'error');
      }
    }

    function iniciarLoopQr(video) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      const loop = () => {
        if (!video.srcObject) return;

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

          if (typeof jsQR === 'undefined') {
            console.error('jsQR n칚o carregado.');
            setStatus('Erro: biblioteca jsQR n칚o carregada.', 'error');
            pararLeituraQr();
            return;
          }

          const code = jsQR(imageData.data, imageData.width, imageData.height);
          if (code && code.data) {
            tratarResultadoQr(code.data);
            pararLeituraQr();
            return;
          }
        }

        qrAnimationId = requestAnimationFrame(loop);
      };

      qrAnimationId = requestAnimationFrame(loop);
    }

    // ========= FOTO FINALIZA칂츾O: normaliza칞칚o de URL + download =========
    function normalizarUrlFoto(url) {
      if (!url) return '';
      url = url.trim();
      // Converte links do console do Google Cloud Storage para URL direta do objeto
      if (url.startsWith('https://storage.cloud.google.com/')) {
        return url.replace('https://storage.cloud.google.com/', 'https://storage.googleapis.com/');
      }
      return url;
    }

    async function baixarFoto(urlOriginal) {
      try {
        const url = normalizarUrlFoto(urlOriginal);
        if (!url) {
          alert('Nenhuma URL de foto dispon칤vel.');
          return;
        }

        const resposta = await fetch(url, { mode: 'cors' });
        if (!resposta.ok) {
          throw new Error('Resposta HTTP inv치lida: ' + resposta.status);
        }

        const blob = await resposta.blob();
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const nomeArquivo = (url.split('/').pop() || 'foto-finalizacao').split('?')[0];

        a.href = blobUrl;
        a.download = nomeArquivo || 'foto-finalizacao';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(blobUrl);
      } catch (erro) {
        console.error('Erro ao baixar a foto:', erro);
        alert('N칚o foi poss칤vel baixar a imagem. Verifique a conex칚o ou se o arquivo 칠 p칰blico.');
      }
    }

    // ========= SERVICE WORKER =========
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .catch(err => console.warn('Service Worker n칚o registrado:', err));
      });
    }

    // Carrega o CSV padr칚o na primeira vez
    carregarCsvPadrao();
  </script>
</body>
</html>
