<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Consulta por NP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: #ffffff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    h1 {
      font-size: 1.3rem;
      margin-top: 0;
      text-align: center;
    }
    .np-highlight {
      font-weight: bold;
      font-size: 1.1rem;
      margin: 8px 0 16px;
      text-align: center;
    }
    .status {
      margin: 8px 0 16px;
      font-size: 0.95rem;
      padding: 8px 12px;
      border-radius: 8px;
      background: #eee;
    }
    .status.error {
      background: #ffe5e5;
      color: #a40000;
    }
    .status.success {
      background: #e5ffe9;
      color: #006614;
    }
    .field-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .field-table th,
    .field-table td {
      padding: 6px 8px;
      vertical-align: top;
      border-bottom: 1px solid #f0f0f0;
    }
    .field-table th {
      text-align: left;
      width: 40%;
      font-weight: 600;
      background: #fafafa;
    }
    .field-table tr:nth-child(even) td {
      background: #fcfcfc;
    }
    .small {
      font-size: 0.8rem;
      color: #777;
      margin-top: 16px;
      text-align: center;
    }
    .search-box {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .search-box input {
      flex: 1;
      min-width: 140px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
    }
    .search-box button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      font-size: 0.95rem;
      cursor: pointer;
      background: #007bff;
      color: white;
      white-space: nowrap;
    }
    .search-box button:active {
      opacity: 0.8;
    }

    /* √Årea da c√¢mera / QR */
    .qr-area {
      margin-top: 12px;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .qr-area video {
      width: 100%;
      max-width: 400px;
      border-radius: 12px;
      background: #000;
    }
    .qr-hint {
      font-size: 0.8rem;
      color: #555;
      text-align: center;
    }

    /* Imagem de fotoFinalizacao */
    .foto-finalizacao {
      margin-top: 8px;
      max-width: 100%;
      border-radius: 8px;
      display: block;
    }
  </style>

  <!-- Papaparse local -->
  <script src="./papaparse.min.js"></script>
  <!-- Biblioteca de leitura de QR -->
  <script src="./jsQR.js"></script>
</head>
<body>
  <div class="container">
    <h1>Consulta de Registro por NP</h1>

    <!-- Busca manual + bot√£o de c√¢mera -->
    <div class="search-box">
      <input id="manualNp" type="text" placeholder="Digite o NP (ex: ab-011)" />
      <button onclick="buscarManual()">Buscar</button>
      <button onclick="iniciarLeituraQr()">üì∑ Ler QR</button>
    </div>

    <!-- √Årea da c√¢mera -->
    <div id="qrArea" class="qr-area">
      <video id="qrVideo" playsinline></video>
      <div class="qr-hint">
        Aponte a c√¢mera para o QR Code. A leitura para automaticamente ao encontrar um c√≥digo.
      </div>
    </div>

    <div id="npInfo" class="np-highlight"></div>
    <div id="status" class="status">Carregando dados...</div>
    <table id="resultTable" class="field-table" style="display:none;"></table>

    <div class="small">
      CSV padr√£o: <strong>dados.csv</strong> (armazenado junto ao app).<br>
      A imagem de <strong>fotoFinalizacao</strong> √© carregada da internet (precisa ter conex√£o).
    </div>
  </div>

  <script>
    // üëâ nome do CSV padr√£o
    const CSV_FILE = 'dados.csv';

    let registros = [];
    let cabecalho = [];

    // Campos que queremos mostrar (al√©m da foto)
    const CAMPOS_VISIVEIS = [
      'np',
      'material',
      'qtde',
      'sitio',
      'added_sitio',
      'locus',
      'UE',
      'nivel',
      'quadriculaLetra',
      'quadriculaNumero',
      'latitude_degrees',
      'longitude_degrees',
      '_altitude',
      'branchTipoAtividade',
      'branchOrigemMaterial',
      'dateFoto',
      'hipoteseSerTestada',
      'obs_inicial',
      'obs_final'
      // fotoFinalizacao ser√° tratada separado
    ];

    const LABELS = {
      np: 'NP',
      material: 'Material',
      qtde: 'Quantidade',
      sitio: 'S√≠tio',
      added_sitio: 'S√≠tio (derivado)',
      locus: 'L√≥cus',
      UE: 'UE',
      nivel: 'N√≠vel',
      quadriculaLetra: 'Quadr√≠cula - Letra',
      quadriculaNumero: 'Quadr√≠cula - N√∫mero',
      latitude_degrees: 'Latitude (graus)',
      longitude_degrees: 'Longitude (graus)',
      _altitude: 'Altitude (m)',
      branchTipoAtividade: 'Tipo de Atividade',
      branchOrigemMaterial: 'Origem do Material',
      dateFoto: 'Data da Foto',
      hipoteseSerTestada: 'Hip√≥tese a ser testada',
      obs_inicial: 'Observa√ß√£o inicial',
      obs_final: 'Observa√ß√£o final'
    };

    function getNpFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const np = params.get('np');
      return np ? np.trim() : null;
    }

    function setStatus(msg, tipo = '') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = msg;
      statusEl.className = 'status';
      if (tipo) statusEl.classList.add(tipo);
    }

    function mostrarRegistro(registro, npBuscado) {
      const npInfo = document.getElementById('npInfo');
      const tabela = document.getElementById('resultTable');

      npInfo.textContent = npBuscado ? `NP consultado: ${npBuscado}` : '';

      if (!registro) {
        tabela.style.display = 'none';
        setStatus('Nenhum registro encontrado para este NP.', 'error');
        return;
      }

      let html = '';

      CAMPOS_VISIVEIS.forEach(col => {
        if (col === 'sitio') {
          const valorSitio = registro['sitio'] || registro['added_sitio'];
          if (valorSitio && valorSitio.trim() !== '') {
            html += `
              <tr>
                <th>${LABELS['sitio']}</th>
                <td>${valorSitio}</td>
              </tr>
            `;
          }
          return;
        }

        const valor = registro[col];
        if (valor === null || valor === undefined) return;
        if (valor.toString().trim() === '') return;

        const label = LABELS[col] || col;
        html += `
          <tr>
            <th>${label}</th>
            <td>${valor}</td>
          </tr>
        `;
      });

      // üëâ Tratamento especial da fotoFinalizacao
      const urlFoto = (registro['fotoFinalizacao'] || '').toString().trim();
      if (urlFoto) {
        html += `
          <tr>
            <th>Foto de Finaliza√ß√£o</th>
            <td>
              <a href="${urlFoto}" target="_blank" rel="noopener noreferrer">
                Abrir em nova aba
              </a><br/>
              <img src="${urlFoto}" alt="Foto de finaliza√ß√£o" class="foto-finalizacao"
                   onerror="this.style.display='none';" />
            </td>
          </tr>
        `;
      }

      if (!html) {
        tabela.style.display = 'none';
        setStatus('Registro encontrado, mas sem campos vis√≠veis configurados.', 'error');
        return;
      }

      tabela.innerHTML = html;
      tabela.style.display = 'table';
      setStatus('Registro encontrado com sucesso.', 'success');
    }

    function buscarPorNp(npValor) {
      if (!npValor) {
        setStatus('Informe um NP para buscar.', 'error');
        mostrarRegistro(null, null);
        return;
      }

      const npNormalizado = npValor.toString().trim().toLowerCase();

      const registro = registros.find(r => {
        const v = (r['np'] || r['NP'] || '').toString().trim().toLowerCase();
        return v === npNormalizado;
      });

      mostrarRegistro(registro, npValor);
    }

    function buscarManual() {
      const valor = document.getElementById('manualNp').value;
      buscarPorNp(valor);

      const url = new URL(window.location);
      if (valor) {
        url.searchParams.set('np', valor);
      } else {
        url.searchParams.delete('np');
      }
      window.history.replaceState({}, '', url);
    }

    function carregarCsv() {
      setStatus('Carregando dados do CSV...');

      Papa.parse(CSV_FILE, {
        download: true,
        header: true,
        skipEmptyLines: true,
        delimiter: ';',
        complete: function(results) {
          if (results.errors && results.errors.length > 0) {
            console.warn('Erros ao ler CSV:', results.errors);
          }

          registros = results.data || [];
          cabecalho = results.meta && results.meta.fields ? results.meta.fields : [];

          if (registros.length === 0) {
            setStatus('Nenhum dado encontrado no CSV.', 'error');
            return;
          }

          setStatus('Dados carregados. Procurando NP...');
          const npUrl = getNpFromUrl();
          if (npUrl) {
            document.getElementById('manualNp').value = npUrl;
            buscarPorNp(npUrl);
          } else {
            setStatus('Digite um NP, use um QR com NP ou clique em üì∑ Ler QR.', '');
          }
        },
        error: function(err) {
          console.error(err);
          setStatus('Erro ao carregar o CSV.', 'error');
        }
      });
    }

    // ========= LEITURA DE QR COM C√ÇMERA =========
    let qrStream = null;
    let qrAnimationId = null;

    async function iniciarLeituraQr() {
      const qrArea = document.getElementById('qrArea');
      const video = document.getElementById('qrVideo');

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        setStatus('Este dispositivo/navegador n√£o suporta acesso √† c√¢mera.', 'error');
        return;
      }

      try {
        setStatus('Abrindo c√¢mera para leitura de QR...', '');
        qrArea.style.display = 'flex';

        qrStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false
        });

        video.srcObject = qrStream;
        await video.play();

        iniciarLoopQr(video);
      } catch (err) {
        console.error(err);
        setStatus('N√£o foi poss√≠vel acessar a c√¢mera (permiss√£o negada ou erro).', 'error');
      }
    }

    function pararLeituraQr() {
      if (qrAnimationId) {
        cancelAnimationFrame(qrAnimationId);
        qrAnimationId = null;
      }
      if (qrStream) {
        qrStream.getTracks().forEach(t => t.stop());
        qrStream = null;
      }
      const qrArea = document.getElementById('qrArea');
      const video = document.getElementById('qrVideo');
      video.srcObject = null;
      qrArea.style.display = 'none';
    }

    function tratarResultadoQr(texto) {
      // Mostra o conte√∫do lido para debug
      setStatus('QR lido: ' + texto, 'success');

      let np = null;

      // 1) Tenta interpretar como URL com ?np=
      try {
        const url = new URL(texto);
        const param = url.searchParams.get('np');
        if (param) np = param;
      } catch (e) {
        // n√£o era URL, tudo bem
      }

      // 2) Se n√£o achou via URL, usa o texto inteiro como NP
      if (!np) np = texto;

      if (np) {
        document.getElementById('manualNp').value = np;
        buscarPorNp(np);
      } else {
        setStatus('QR lido, mas n√£o foi poss√≠vel identificar o NP.', 'error');
      }
    }

    function iniciarLoopQr(video) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      const loop = () => {
        if (!video.srcObject) return;

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

          if (typeof jsQR === 'undefined') {
            console.error('jsQR n√£o carregado.');
            setStatus('Erro: biblioteca jsQR n√£o carregada.', 'error');
            pararLeituraQr();
            return;
          }

          const code = jsQR(imageData.data, imageData.width, imageData.height);
          if (code && code.data) {
            tratarResultadoQr(code.data);
            pararLeituraQr();
            return;
          }
        }

        qrAnimationId = requestAnimationFrame(loop);
      };

      qrAnimationId = requestAnimationFrame(loop);
    }

    // ========= SERVICE WORKER =========
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .catch(err => console.warn('Service Worker n√£o registrado:', err));
      });
    }

    // Carrega o CSV na primeira vez
    carregarCsv();
  </script>
</body>
</html>
